{% extends 'rootpage.html' %}
{% load static %}
<html>
{% block content %}

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
    <link rel="stylesheet" href="{% static 'css/new.css' %} " />
    <title>Checkout</title>

    <style>
        .box {
            box-shadow: hsl(0, 3%, 65%) 0 0 16px;
            background-color: #fff;
            border-radius: 4px;
            padding: 10px;
        }

        .cartrow {
            display: flex;
            align-items: flex-stretch;
            padding-bottom: 10px;
            padding-top: 10px;
            border-bottom: 1px rgb(47, 38, 38);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body style="min-height: 100vh; display: flex; flex-direction: column; background-color: #fff; ">
    <div class="container-fluid">
        <div class="row">
            <!-- header -->
            <div class="hbar" style="background-color: #fff;">
                <div class="logo"> <img src="{% static  'img/images/logo.png' %}" width="128px" height="128px" /> </div>

                <div class="searchbar">
                    <form>
                        <input type="search" id="search" name="search" />
                    </form>
                </div>

                <div class="signhome">
                    <form>
                        <button id="sign"><b>Sign in</b></button>
                    </form>
                </div>
            </div>
            <!-- navigationbar -->
            <div class="col-lg-12 navdiv">
                <nav class="navbar navbar-expand-lg navbar-light bg-light ">

                    <div class="collapse navbar-collapse " id="navbarNav">
                        <ul class="navbar-nav navlist ">
                            <li class="nav-item active">
                                <a class="nav-link" href="{% url 'home' %}">Home</a>
                            </li>

                            <li class="nav-item">
                                <a class="nav-link movenav" href="#">Pets</a> +

                            </li>
                            <li class="nav-item">
                                <a class="nav-link movenav" href="#">Pet accessories</a>
                            </li>
                            <li class="nav-item movenav">
                                <a class="nav-link" href="#">Pet Food</a>
                            </li>
                            <li class="nav-item movenav">
                                <a class="nav-link" href="#">Our services</a>
                            </li>
                            <li class="nav-item movenav">
                                <div>
                                    <a class="nav-link movenav" style="margin-left: 600px;" href="{% url 'cart' %}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                                            fill="currentColor" class="bi bi-cart" viewBox="0 0 16 16">
                                            <path
                                                d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.102 4l1.313 7h8.17l1.313-7H3.102zM5 12a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm7 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm-7 1a1 1 0 1 1 0 2 1 1 0 0 1 0-2zm7 0a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                                        </svg>
                                        <p style="color: red;float: right; font-size: 12px;"> {{cartItems}} </p>
                                    </a>

                                    </a>

                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>

            <br>
            <br>
            <br>


            <div class="row">
                <div class="col-lg-6">
                    <div class="box-element" id="form-wrapper">
                        <form id="form">
                            <div id="user-info">
                                <div class="form-field">
                                    <input required style="width: 300px;" class="form-control" type="text" name="name"
                                        placeholder="Name..">
                                </div>
                                <br>
                                <div class="form-field">
                                    <input required style="width: 300px;" class="form-control" type="email" name="email"
                                        placeholder="Email..">
                                </div>
                            </div>

                            <div id="shipping-info">
                                <hr>
                                <p>Shipping Information:</p>
                                <hr>
                                <div class="form-field ">
                                    <input style="width: 200px;" class="form-control" type="text" name="address"
                                        placeholder="Address..">
                                </div>
                                <br>
                                <div class="form-field">
                                    <input style="width: 300px;" class="form-control" type="text" name="city"
                                        placeholder="City..">
                                </div>
                                <br>
                                <div class="form-field">
                                    <input style="width: 300px;" class="form-control" type="text" name="state"
                                        placeholder="State..">
                                </div>
                                <br>
                                <div class="form-field">
                                    <input style="width: 300px;" class="form-control" type="text" name="zipcode"
                                        placeholder="Zip code..">
                                </div>
                                <br>
                                <div class="form-field">
                                    <input style="width: 300px;" class="form-control" type="text" name="country"
                                        placeholder="Zip code..">
                                </div>
                            </div>

                            <hr>
                            <input id="form-button" class="btn btn-success btn-block" type="submit" value="Continue">
                        </form>
                    </div>

                    <br>

                    <div class="box hidden" id="place-order-box">
                        <input id="place-order" class="btn btn-success btn-block" type="submit" value="Place Order">
                    </div>



                </div>

                <div class="col-lg-6">

                    <div class="box">
                        <p style="font-family: Arial, Helvetica, sans-serif;">
                            <strong>
                                <span>Your Order Summary </span>
                            </strong>
                        </p>
                        <hr>
                        <div class="cartrow">
                            <div style="flex:2">
                                Image
                            </div>
                            <div style="flex:2">
                                Item
                            </div>
                            <div style="flex:1">
                                Price
                            </div>
                            <div style="flex:1">
                                Quantity
                            </div>
                            <div style="flex:1">
                                Total
                            </div>
                        </div>

                        {% for item in items %}

                        <div class="cartrow">
                            <div style="flex:2">
                                <img src="{{item.item.imageurl}}" width="70px">
                            </div>

                            <div style="flex:2">
                                {{item.item.title}}
                            </div>
                            <div style="flex:1">
                                Rs{{item.item.price}}
                            </div>
                            <div style="flex:1">

                                <p style="display: inline-block; padding-right: 10px; position: sticky; top:0px ">
                                    {{item.quantity}}
                                </p>


                            </div>
                            <div style="flex:1">
                                {{item.getTotal}}
                            </div>
                        </div>
                        {% endfor %}

                        <br>
                        <hr>



                    </div>

                    <br>

                    <div class="box">
                        <div class="cartrow">
                            <div style="flex:3">


                            </div>

                            <div style="flex:2">
                                Items: {{order.getCartItems}}

                            </div>
                            <div style="flex:2">
                                Total price: {{order.getCartTotal}}

                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- dont show form if shipping false -->
    <script type="text/javascript">

        var shipping = '{{order.shipping}}'
        var cart_total = ' {{order.getCartTotal}}'

        if (shipping == 'False') {
            document.getElementById('shipping-info').innerHTML = ''

        }

        if (user != 'AnonymousUser') {
            document.getElementById('user-info').innerHTML = ''
        }

        if (shipping == 'False' && user != 'AnonymousUser') {
            document.getElementById('form-wrapper').classList.add('hidden');

        }

        var form = document.getElementById('form')

        form.addEventListener('submit', function (e) {
            e.preventDefault()
            console.log('submitted')
            document.getElementById('form-button').classList.add('hidden')
            document.getElementById('place-order-box').classList.remove('hidden')
        })

        // checkout process function
        document.getElementById('place-order').addEventListener('click', function(e){
            submitCheckoutForm()
        })
        function submitCheckoutForm() {

            var userFormData = {
                'name': null,
                'email': null,
                'cart_total': cart_total
            }

            var userShippingData = {
                'address': null,
                'city': null,
                'state': null,
                'zipcode': null,

            }

            if (shipping != 'False') {
                userShippingData.address = form.address.value
                userShippingData.city = form.address.value
                userShippingData.state = form.address.value
                userShippingData.zipcode = form.address.value
            }

            if (user == 'AnonymousUser') {
                userFormData.name = form.name.value
                userShippingData.email = form.email.value

            }

            var url = '/process-checkout/'

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-type': 'application/json',
                    'X-CSRFToken': csrftoken,

                },
                body: JSON.stringify({ 'form': userFormData, 'shipping': userShippingData })
            })
            .then((response) => response.json())
            .then((data) => {
                    console.log(data)
                    alert('ORDER PLACED')
                    window.location.href = "{%url 'home'%}"

                })

        }



    </script>

</body>

{% endblock %}

</html>